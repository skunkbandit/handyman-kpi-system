"""\nTest suite for SQLite database adapter.\n\nThis module contains comprehensive tests for the SQLite database adapter\nto ensure it functions correctly and handles edge cases appropriately.\n"""\n\nimport os\nimport sys\nimport unittest\nimport tempfile\nimport shutil\nimport sqlite3\nfrom unittest.mock import patch, MagicMock\n\n# Add the main project directory to the path\nsys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../../../../')))\n\nfrom installer.shared.database.adapters import get_adapter\n\n\nclass TestSQLiteAdapter(unittest.TestCase):\n    """Test SQLite database adapter."""\n    \n    def setUp(self):\n        """Set up test environment."""\n        # Create temporary directory for test database\n        self.temp_dir = tempfile.mkdtemp()\n        self.db_path = os.path.join(self.temp_dir, 'test.db')\n        self.config = {\n            'path': self.db_path\n        }\n        \n        # Simple schema for testing\n        self.schema = """\n        CREATE TABLE users (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            username TEXT UNIQUE NOT NULL,\n            password_hash TEXT NOT NULL,\n            salt TEXT NOT NULL,\n            email TEXT,\n            is_admin INTEGER DEFAULT 0\n        );\n        """\n        \n        # Create adapter\n        self.adapter = get_adapter('sqlite', self.config)\n    \n    def tearDown(self):\n        """Clean up test environment."""\n        if os.path.exists(self.temp_dir):\n            shutil.rmtree(self.temp_dir)\n    \n    def test_adapter_creation(self):\n        """Test adapter creation."""\n        # Test with valid configuration\n        adapter = get_adapter('sqlite', self.config)\n        self.assertIsNotNone(adapter)\n        self.assertEqual(adapter.db_path, self.db_path)\n        \n        # Test with missing path (should use default)\n        adapter = get_adapter('sqlite', {})\n        self.assertIsNotNone(adapter)\n        self.assertEqual(adapter.db_path, 'data/database.db')\n    \n    def test_connection(self):\n        """Test database connection."""\n        # Test connection to new database (should create file)\n        self.assertTrue(self.adapter.test_connection())\n        self.assertTrue(os.path.exists(self.db_path))\n        \n        # Test connection to existing database\n        self.assertTrue(self.adapter.test_connection())\n    \n    def test_connection_failure(self):\n        """Test connection failure scenarios."""\n        # Test with invalid path (directory instead of file)\n        invalid_dir = os.path.join(self.temp_dir, 'invalid_dir')\n        os.makedirs(invalid_dir, exist_ok=True)\n        \n        adapter = get_adapter('sqlite', {'path': invalid_dir})\n        self.assertFalse(adapter.test_connection())\n    \n    def test_initialization(self):\n        """Test database initialization."""\n        # Initialize database\n        self.assertTrue(self.adapter.initialize(self.schema))\n        self.assertTrue(os.path.exists(self.db_path))\n        \n        # Verify table was created\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='users'")\n        self.assertIsNotNone(cursor.fetchone())\n        conn.close()\n    \n    def test_initialization_with_invalid_schema(self):\n        """Test initialization with invalid schema."""\n        # Test with invalid SQL\n        invalid_schema = "CREATE TABLE invalid_syntax (id INTEGER PRIMARY"  # Missing closing parenthesis\n        self.assertFalse(self.adapter.initialize(invalid_schema))\n    \n    def test_admin_user_creation(self):\n        """Test admin user creation."""\n        # Initialize database\n        self.adapter.initialize(self.schema)\n        \n        # Create admin user\n        username = "admin"\n        password = "Password123"\n        email = "admin@example.com"\n        \n        self.assertTrue(self.adapter.create_admin_user(username, password, email))\n        \n        # Verify admin user was created\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        cursor.execute("SELECT id, username, email, is_admin FROM users WHERE username = ?", (username,))\n        user = cursor.fetchone()\n        conn.close()\n        \n        self.assertIsNotNone(user)\n        self.assertEqual(user[1], username)\n        self.assertEqual(user[2], email)\n        self.assertEqual(user[3], 1)  # is_admin = 1\n    \n    def test_admin_user_update(self):\n        """Test admin user update if already exists."""\n        # Initialize database and create initial admin user\n        self.adapter.initialize(self.schema)\n        \n        username = "admin"\n        password1 = "Password123"\n        email1 = "admin@example.com"\n        \n        self.adapter.create_admin_user(username, password1, email1)\n        \n        # Update admin user with new email and password\n        password2 = "NewPassword456"\n        email2 = "new_admin@example.com"\n        \n        self.assertTrue(self.adapter.create_admin_user(username, password2, email2))\n        \n        # Verify admin user was updated\n        conn = sqlite3.connect(self.db_path)\n        cursor = conn.cursor()\n        cursor.execute("SELECT id, username, email, is_admin FROM users WHERE username = ?", (username,))\n        user = cursor.fetchone()\n        conn.close()\n        \n        self.assertIsNotNone(user)\n        self.assertEqual(user[1], username)\n        self.assertEqual(user[2], email2)\n        self.assertEqual(user[3], 1)  # is_admin = 1