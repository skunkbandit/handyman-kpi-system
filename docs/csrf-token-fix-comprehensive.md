# Comprehensive CSRF Token Fix

## Background

After fixing the CSRF token issue in employee forms, we discovered that the same issue affects multiple forms throughout the application, including evaluation forms, user management forms, and others.

## What is CSRF?

**Cross-Site Request Forgery (CSRF)** is a type of security vulnerability where unauthorized commands are executed on behalf of an authenticated user without their knowledge. CSRF attacks trick users into submitting a malicious request through an external site or email.

Flask applications use the Flask-WTF extension to protect against these attacks by requiring a unique token with each form submission that can only be generated by the legitimate website.

## The Problem

Forms throughout the application lack the required CSRF token, resulting in a "400 Bad Request: The CSRF token is missing" error when submitted. This affects:

1. Employee management forms (create, edit, delete)
2. Evaluation forms (create, edit)
3. User management forms
4. Authentication forms (login, reset password, etc.)
5. Reports and admin forms that use POST requests

## The Comprehensive Fix

We've created a script that automatically adds CSRF tokens to all forms in the application that use the POST method:

### How It Works

1. The script recursively finds all HTML template files in the application
2. For each template, it checks if it contains any forms with `method="post"`
3. If a form is found that doesn't already have a CSRF token, the script adds one
4. The script creates backups of all modified files

### Using the Fix Script

```bash
# Run from the project root directory
python scripts/fix_all_csrf_tokens.py
```

### What Gets Added

For each form that uses the POST method, the script adds this line:

```html
<!-- CSRF Token -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
```

This is added right after the opening `<form>` tag.

## Manually Fixing Forms

If you need to manually add CSRF tokens to your forms:

1. Open the template file containing the form
2. Locate the opening `<form>` tag
3. Add the CSRF token input field after the opening tag:
   ```html
   <form method="post" ...>
       <!-- CSRF Token -->
       <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
       <!-- Rest of the form -->
   </form>
   ```

## Preventing Future Issues

To prevent this issue from occurring in future development:

### 1. Use Form Macros

Create a Jinja2 macro for your forms:

```html
{% macro csrf_field() %}
<!-- CSRF Token -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
{% endmacro %}
```

Then use it in your forms:

```html
<form method="post" ...>
    {{ csrf_field() }}
    <!-- Form fields -->
</form>
```

### 2. Create a Base Form Template

Create a base form template that all forms extend, which automatically includes the CSRF token.

### 3. Implement Client-Side Validation

Add JavaScript validation to check for the CSRF token before form submission.

### 4. Add to Code Review Process

Add CSRF token validation to your pre-commit code review checklist.

## Further Resources

- [Flask-WTF Documentation](https://flask-wtf.readthedocs.io/en/stable/csrf.html)
- [OWASP CSRF Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)
